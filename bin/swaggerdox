#!/usr/bin/env node

var program = require('commander'),
    packageInfo = require('../package'),
    doxSwagger = require('dox-swagger'),
    path = require('path'),
    mkdirp = require('mkdirp');
fs = require('fs'),
    path = require('path');


program
    .version(packageInfo.version)
    .option('-b, --basePath [http://localhost]', 'api url path default use localhost', 'http://localhost')
    .option('-d, --description', 'api description')
    .option('-m, --models [models]', 'spec doc models dir')
    .option('-o, --output [docs]', 'spec doc output dir', 'docs')
    .option('-i, --input [lib]', 'code dir default use lib', 'lib')
    .parse(process.argv);


if (!/(http|https)/.test(program.basePath)) {
    program.basePath = 'http://' + program.basePath;
}


//current path

var basePath = path.resolve('.');

var codeDir = path.join(basePath, program.input);

mkdirp.sync(codeDir);

if (program.output) {
    mkdirp.sync(path.join(basePath, program.output));
}

//加载模型定义
if (program.models) {
    var modelDir = path.join(basePath, program.models);

    var modelFiles = fs.readdirSync(modelDir);


    var modelObj = {};
    modelFiles.forEach(function (item) {

        var point = item.lastIndexOf(".");
        var name = item.substr(0, point);

        modelObj[name] = require(path.join(modelDir, item))
    })

    program.models = modelObj;

}


var files = fs.readdirSync(codeDir);


files.forEach(function (item) {

    var point = item.lastIndexOf(".");

    var type = item.substr(point);

    if (type === '.js') {
        doxSwagger.doxSwagger(path.join(codeDir, item), program);
    }

})

fs.writeFileSync(path.join(program.output, 'api-docs'), JSON.stringify(doxSwagger.apiResourceList));


